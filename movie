#!/usr/bin/env ruby

require_relative 'lib/environment'
require_relative 'lib/parse_arguments'
require_relative 'models/movie_entry'

command = ARGV[0]
options = ParseArguments.parse
options[:title] = ARGV[1]

Environment.environment = options[:environment] || "production"
database = Environment.database_connection

if command == "search"
  puts "What do you want to search for?"
  input = $stdin.gets.chomp
  puts "You asked for: #{input}"
  statement = "select cinephile_movies_test.title from cinephile_movies_test where title LIKE '%#{input}'"
  results = database.execute(statement)
  puts results
elsif command == "add"
  error_messages = ParseArguments.validate(options)
  if error_messages.empty?
    # This is ripe for SQL injection attack:
    statement = "insert into cinephile_movies_test(title, seen, own, wishlist_see, wishlist_own, user_rating) values('#{options[:title]}', '#{options[:seen]}', '#{options[:own]}', '#{options[:wishlist_see]}', '#{options[:wishlist_own]}', '#{options[:user_rating]}')"
    database.execute(statement)
    puts "A movie named #{options[:title]}, with seen? #{options[:seen]}, own? #{options[:own]}, wishlist see #{options[:wishlist_see]}, wishlist own #{options[:wishlist_own]}, user rating #{options[:user_rating]}"
  else
    puts error_messages
  end
elsif command == "list"
  puts "All Movies:"
  puts MovieEntry.all
else
  puts "Command not implemented"
end